<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submissions Dashboard</title>
    <link rel="stylesheet" href="./style/app.css">
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <!-- Navigation -->
    <nav class="bg-white shadow-md mb-8">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-2xl font-bold text-gray-800">Submissions Dashboard</h1>
                <a href="index.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    New Submission
                </a>
            </div>
        </div>
    </nav>

    <!-- Search and Controls -->
    <div class="max-w-6xl mx-auto px-4 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <div class="flex flex-col md:flex-row gap-4 items-center flex-1">
                    <!-- Search Input -->
                    <div class="relative flex-1 max-w-md">
                        <input type="text" id="searchInput" placeholder="Search by ID, Problem Statement..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <svg class="absolute left-3 top-2.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    
                    <!-- Filter by Problem Statement -->
                    <select id="problemFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">All Problems</option>
                        <option value="Healthcare Innovation">Healthcare Innovation</option>
                        <option value="Educational Technology">Educational Technology</option>
                        <option value="Environmental Sustainability">Environmental Sustainability</option>
                        <option value="Financial Technology">Financial Technology</option>
                        <option value="Smart Transportation">Smart Transportation</option>
                        <option value="Agriculture Technology">Agriculture Technology</option>
                        <option value="Renewable Energy">Renewable Energy</option>
                        <option value="Social Impact">Social Impact</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- Fetch Button -->
                <button type="button" id="fetchBtn" 
                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span id="fetchBtnText">Fetch Data</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingSpinner" class="hidden max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-md p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Loading submissions...</p>
        </div>
    </div>

    <!-- Statistics -->
    <div id="statsContainer" class="hidden max-w-6xl mx-auto px-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Total Submissions</h3>
                <p id="totalCount" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Healthcare</h3>
                <p id="healthcareCount" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Education</h3>
                <p id="educationCount" class="text-3xl font-bold text-purple-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 text-center">
                <h3 class="text-lg font-semibold text-gray-700">Environment</h3>
                <p id="environmentCount" class="text-3xl font-bold text-emerald-600">0</p>
            </div>
        </div>
    </div>

    <!-- No Data State -->
    <div id="noDataMessage" class="hidden max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-xl font-medium text-gray-700 mb-2">No submissions found</h3>
            <p class="text-gray-500">Try adjusting your search criteria or fetch the latest data.</p>
        </div>
    </div>

    <!-- Data Table -->
    <div id="dataContainer" class="hidden max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Unique ID
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Problem Statement
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Logo
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Poster
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Submitted At
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 p-4" style="display: none;">
        <div class="flex items-center justify-center min-h-screen">
            <div class="relative max-w-4xl max-h-full">
                <button id="closeModal" class="absolute top-2 right-2 text-white hover:text-gray-300 text-3xl font-bold z-10 w-10 h-10 flex items-center justify-center bg-black bg-opacity-50 rounded-full">
                    &times;
                </button>
                <img id="modalImage" src="" alt="Full size image" class="max-w-full max-h-screen object-contain rounded-lg">
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 p-4" style="display: none;">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">Submission Details</h3>
                        <button id="closeDetailsModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                            &times;
                        </button>
                    </div>
                    <div id="detailsContent">
                        <!-- Details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { storage, databases } from './lib/appwrite.js';
        
        // Configuration
        const BUCKET_ID = import.meta.env.VITE_APPWRITE_BUCKET_ID;
        const DATABASE_ID = import.meta.env.VITE_APPWRITE_DATABASE_ID;
        const COLLECTION_ID = import.meta.env.VITE_APPWRITE_COLLECTION_ID;

        let submissionsData = [];
        let filteredData = [];
        let currentSearchTerm = '';
        let currentFilter = '';

        // Helper function to get image URL from Appwrite Storage
        function getImageUrl(fileId) {
            return storage.getFileView(BUCKET_ID, fileId);
        }

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const problemFilter = document.getElementById('problemFilter');
        const fetchBtn = document.getElementById('fetchBtn');
        const fetchBtnText = document.getElementById('fetchBtnText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const noDataMessage = document.getElementById('noDataMessage');
        const dataContainer = document.getElementById('dataContainer');
        const statsContainer = document.getElementById('statsContainer');
        const dataTableBody = document.getElementById('dataTableBody');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        const detailsModal = document.getElementById('detailsModal');
        const detailsContent = document.getElementById('detailsContent');
        const closeDetailsModal = document.getElementById('closeDetailsModal');

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Search input
            searchInput.addEventListener('input', function() {
                currentSearchTerm = this.value.toLowerCase();
                filterAndDisplayData();
            });

            // Problem filter
            problemFilter.addEventListener('change', function() {
                currentFilter = this.value;
                filterAndDisplayData();
            });

            // Fetch button
            fetchBtn.addEventListener('click', fetchData);

            // Modal close buttons
            closeModal.addEventListener('click', () => {
                imageModal.classList.add('hidden');
                imageModal.style.display = 'none';
            });
            
            closeDetailsModal.addEventListener('click', () => {
                detailsModal.classList.add('hidden');
                detailsModal.style.display = 'none';
            });

            // Close modals on outside click
            imageModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                    this.style.display = 'none';
                }
            });

            detailsModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                    this.style.display = 'none';
                }
            });
        }

        async function fetchData() {
            showLoading();
            
            try {
                // Fetch submissions from Appwrite Database
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    COLLECTION_ID
                );
                
                // Transform Appwrite documents to our format
                submissionsData = response.documents.map(doc => ({
                    id: doc.uniqueId,
                    problemStatement: doc.problemStatement,
                    logoUrl: getImageUrl(doc.logoFileId),
                    posterUrl: getImageUrl(doc.posterFileId),
                    logoFileName: doc.logoFileName,
                    posterFileName: doc.posterFileName,
                    submittedAt: doc.submittedAt,
                    documentId: doc.$id,
                    logoFileId: doc.logoFileId,
                    posterFileId: doc.posterFileId
                }));
                
                filteredData = [...submissionsData];
                updateStatistics();
                displayData();
                hideLoading();
                
                fetchBtnText.textContent = 'Refresh Data';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                hideLoading();
                showNoData();
                
                // Show error message to user
                const errorDiv = document.createElement('div');
                errorDiv.className = 'max-w-6xl mx-auto px-4 mb-6';
                errorDiv.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong>Error:</strong> Failed to fetch submissions. ${error.message}
                    </div>
                `;
                document.body.insertBefore(errorDiv, document.getElementById('loadingSpinner'));
                
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        function showLoading() {
            loadingSpinner.classList.remove('hidden');
            dataContainer.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            statsContainer.classList.add('hidden');
            fetchBtn.disabled = true;
            fetchBtnText.textContent = 'Loading...';
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
            fetchBtn.disabled = false;
        }

        function showNoData() {
            noDataMessage.classList.remove('hidden');
            dataContainer.classList.add('hidden');
            statsContainer.classList.add('hidden');
        }

        function filterAndDisplayData() {
            filteredData = submissionsData.filter(item => {
                const matchesSearch = !currentSearchTerm || 
                    item.id.toLowerCase().includes(currentSearchTerm) ||
                    item.problemStatement.toLowerCase().includes(currentSearchTerm) ||
                    (item.description && item.description.toLowerCase().includes(currentSearchTerm));
                
                const matchesFilter = !currentFilter || item.problemStatement === currentFilter;
                
                return matchesSearch && matchesFilter;
            });

            displayData();
        }

        function updateStatistics() {
            const total = submissionsData.length;
            const healthcare = submissionsData.filter(item => item.problemStatement === 'Healthcare Innovation').length;
            const education = submissionsData.filter(item => item.problemStatement === 'Educational Technology').length;
            const environment = submissionsData.filter(item => item.problemStatement === 'Environmental Sustainability').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('healthcareCount').textContent = healthcare;
            document.getElementById('educationCount').textContent = education;
            document.getElementById('environmentCount').textContent = environment;
        }

        function displayData() {
            if (filteredData.length === 0) {
                showNoData();
                return;
            }

            statsContainer.classList.remove('hidden');
            dataContainer.classList.remove('hidden');
            noDataMessage.classList.add('hidden');

            dataTableBody.innerHTML = '';

            filteredData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${item.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${item.problemStatement}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${item.logoUrl}" alt="Logo" class="h-12 w-12 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity" 
                             onclick="showImageModal('${item.logoUrl}')"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;48&quot; height=&quot;48&quot; viewBox=&quot;0 0 48 48&quot;><rect width=&quot;48&quot; height=&quot;48&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;24&quot; y=&quot;28&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-family=&quot;Arial&quot; font-size=&quot;10&quot;>ERROR</text></svg>'">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${item.posterUrl}" alt="Poster" class="h-12 w-12 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity" 
                             onclick="showImageModal('${item.posterUrl}')"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;48&quot; height=&quot;48&quot; viewBox=&quot;0 0 48 48&quot;><rect width=&quot;48&quot; height=&quot;48&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;24&quot; y=&quot;28&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-family=&quot;Arial&quot; font-size=&quot;10&quot;>ERROR</text></svg>'">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(item.submittedAt)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showDetails('${item.id}')" 
                                class="text-blue-600 hover:text-blue-900 mr-3">View Details</button>
                        <button onclick="deleteSubmission('${item.id}')" 
                                class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                
                dataTableBody.appendChild(row);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function showImageModal(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.remove('hidden');
            imageModal.style.display = 'block';
        }

        function showDetails(id) {
            const item = submissionsData.find(submission => submission.id === id);
            if (!item) return;

            detailsContent.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Unique ID</label>
                            <p class="mt-1 text-lg font-semibold text-gray-900">${item.id}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Submitted At</label>
                            <p class="mt-1 text-sm text-gray-900">${formatDate(item.submittedAt)}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Problem Statement</label>
                        <p class="mt-1 text-sm text-gray-900">${item.problemStatement}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Logo (${item.logoFileName || 'logo.jpg'})</label>
                            <img src="${item.logoUrl}" alt="Logo" class="w-full h-32 object-cover rounded border cursor-pointer hover:opacity-75 transition-opacity" 
                                 onclick="showImageModal('${item.logoUrl}')"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;200&quot; height=&quot;128&quot; viewBox=&quot;0 0 200 128&quot;><rect width=&quot;200&quot; height=&quot;128&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;100&quot; y=&quot;70&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-family=&quot;Arial&quot; font-size=&quot;14&quot;>Image Not Found</text></svg>'">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Poster (${item.posterFileName || 'poster.jpg'})</label>
                            <img src="${item.posterUrl}" alt="Poster" class="w-full h-32 object-cover rounded border cursor-pointer hover:opacity-75 transition-opacity" 
                                 onclick="showImageModal('${item.posterUrl}')"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;200&quot; height=&quot;128&quot; viewBox=&quot;0 0 200 128&quot;><rect width=&quot;200&quot; height=&quot;128&quot; fill=&quot;%23f3f4f6&quot;/><text x=&quot;100&quot; y=&quot;70&quot; text-anchor=&quot;middle&quot; fill=&quot;%236b7280&quot; font-family=&quot;Arial&quot; font-size=&quot;14&quot;>Image Not Found</text></svg>'">
                        </div>
                    </div>
                </div>
            `;
            
            detailsModal.classList.remove('hidden');
            detailsModal.style.display = 'block';
        }

        function deleteSubmission(id) {
            if (confirm('Are you sure you want to delete this submission? This action cannot be undone.')) {
                // Find the submission to get document and file IDs
                const submission = submissionsData.find(item => item.id === id);
                if (!submission) return;
                
                // Delete from Appwrite
                Promise.all([
                    databases.deleteDocument(DATABASE_ID, COLLECTION_ID, submission.documentId),
                    storage.deleteFile(BUCKET_ID, submission.logoFileId),
                    storage.deleteFile(BUCKET_ID, submission.posterFileId)
                ]).then(() => {
                    // Remove from local data
                    submissionsData = submissionsData.filter(item => item.id !== id);
                    filterAndDisplayData();
                    updateStatistics();
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'max-w-6xl mx-auto px-4 mb-6';
                    successDiv.innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            Submission deleted successfully!
                        </div>
                    `;
                    document.body.insertBefore(successDiv, document.getElementById('loadingSpinner'));
                    
                    setTimeout(() => successDiv.remove(), 3000);
                }).catch(error => {
                    console.error('Error deleting submission:', error);
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'max-w-6xl mx-auto px-4 mb-6';
                    errorDiv.innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong>Error:</strong> Failed to delete submission. ${error.message}
                        </div>
                    `;
                    document.body.insertBefore(errorDiv, document.getElementById('loadingSpinner'));
                    
                    setTimeout(() => errorDiv.remove(), 5000);
                });
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                imageModal.classList.add('hidden');
                imageModal.style.display = 'none';
                detailsModal.classList.add('hidden');
                detailsModal.style.display = 'none';
            }
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
            }
        });
    </script>
</body>
</html>
