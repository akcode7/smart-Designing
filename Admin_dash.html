<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Participant Management</title>
    <link rel="stylesheet" href="./style/app.css">
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <!-- Authentication Screen -->
    <div id="adminAuthScreen" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <div class="mx-auto h-12 w-12 bg-green-600 rounded-lg flex items-center justify-center">
                    <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Administrator Login
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Please enter your administrator credentials to access the admin dashboard
                </p>
            </div>
            <form class="mt-8 space-y-6" id="adminLoginForm">
                <div class="space-y-4">
                    <div>
                        <label for="adminUsername" class="block text-sm font-medium text-gray-700">Administrator Username</label>
                        <input 
                            id="adminUsername" 
                            name="username" 
                            type="text" 
                            required 
                            class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500 focus:z-10 sm:text-sm" 
                            placeholder="Enter your admin username"
                        >
                    </div>
                </div>

                <div>
                    <button 
                        type="submit" 
                        id="adminLoginBtn"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span id="adminLoginBtnText">Sign in as Administrator</span>
                        <svg id="adminLoginSpinner" class="hidden animate-spin -mr-1 ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>

                <div id="adminAuthError" class="hidden mt-4 p-4 rounded-md bg-red-100 text-red-700"></div>
            </form>

            <div class="text-center">
                <a href="index.html" class="text-sm text-green-600 hover:text-green-500">
                    Back to Main Application
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Content (Will be dynamically loaded after authentication) -->
    <div id="adminDashboardContent">
        <!-- Dashboard content will be loaded here after successful authentication -->
    </div>

    <script type="module" src="./lib/appwrite.js"></script>
    <script type="module">
        import { storage, databases } from './lib/appwrite.js';
        import { ID, Query } from "appwrite";

        // Configuration
        const BUCKET_ID = import.meta.env.VITE_APPWRITE_BUCKET_ID;
        const DATABASE_ID = import.meta.env.VITE_APPWRITE_DATABASE_ID;
        const COLLECTION_ID = import.meta.env.VITE_APPWRITE_COLLECTION_ID;
        const PARTICIPANTS_COLLECTION_ID = import.meta.env.VITE_APPWRITE_PARTICIPANTS_COLLECTION_ID;
        const USER_ROLES_COLLECTION_ID = import.meta.env.VITE_APPWRITE_USER_ROLES_COLLECTION_ID;

        // Debug environment variables
        console.log('Environment variables loaded:', {
            BUCKET_ID,
            DATABASE_ID,
            COLLECTION_ID,
            PARTICIPANTS_COLLECTION_ID,
            USER_ROLES_COLLECTION_ID
        });

        // State
        let allParticipants = [];
        let allSubmissions = [];
        let currentLoggedInAdmin = null;

        // Authentication functions
        async function authenticateAdmin(username) {
            try {
                console.log('Attempting to authenticate admin:', username);
                console.log('Environment variables:', {
                    DATABASE_ID,
                    USER_ROLES_COLLECTION_ID
                });
                
                // Check user credentials in the user_roles collection
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    USER_ROLES_COLLECTION_ID,
                    [
                        Query.equal('unique_user_name', username),
                        Query.equal('user_role', 'administrator')
                    ]
                );

                console.log('Database response:', response);

                if (response.documents.length === 0) {
                    throw new Error('Invalid username or insufficient permissions');
                }

                const user = response.documents[0];
                currentLoggedInAdmin = user;
                console.log('Authentication successful for:', user);
                return true;
            } catch (error) {
                console.error('Authentication error:', error);
                throw error;
            }
        }

        function showAuthScreen() {
            document.getElementById('adminAuthScreen').classList.remove('hidden');
            document.getElementById('adminDashboardContent').innerHTML = '<!-- Dashboard content will be loaded here after successful authentication -->';
        }

        function showDashboard() {
            document.getElementById('adminAuthScreen').classList.add('hidden');
            loadAdminDashboardContent();
            
            // Load dashboard data after content is loaded
            setTimeout(async () => {
                await loadDashboardData();
            }, 100);
        }

        function loadAdminDashboardContent() {
            const dashboardHTML = `
                <!-- Admin Panel -->
                <div class="container mx-auto max-w-6xl px-4">
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-2">Admin Dashboard</h1>
                                <p class="text-gray-600">Manage participants and view submissions</p>
                            </div>
                            <div class="flex space-x-4">
                                <button 
                                    id="adminLogoutBtn"
                                    class="px-4 py-2 text-sm font-medium text-red-600 hover:text-red-800 border border-red-300 rounded-md hover:bg-red-50"
                                >
                                    Logout
                                </button>
                                <a 
                                    href="judging.html"
                                    class="px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 border border-blue-300 rounded-md hover:bg-blue-50"
                                >
                                    View Submissions
                                </a>
                                <a 
                                    href="index.html"
                                    class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 border border-gray-300 rounded-md hover:bg-gray-50"
                                >
                                    Back to Login
                                </a>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-blue-600">Total Participants</p>
                                        <p id="totalParticipants" class="text-2xl font-bold text-blue-900">0</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-green-600">CSV Uploads</p>
                                        <p id="csvUploads" class="text-2xl font-bold text-green-900">0</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-yellow-600">Last Update</p>
                                        <p id="lastUpdate" class="text-2xl font-bold text-yellow-900">--</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- Add Single Participant -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Add Single Participant</h3>
                                <form id="addParticipantForm" class="space-y-4">
                                    <div>
                                        <label for="participantId" class="block text-sm font-medium text-gray-700">Unique ID <span class="text-red-500">*</span></label>
                                        <input type="text" id="participantId" name="participantId" required
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                               placeholder="e.g., SD001">
                                    </div>
                                    <button type="submit" 
                                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                        Add Participant
                                    </button>
                                </form>
                            </div>

                            <!-- CSV Upload -->
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Bulk Upload via CSV</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="csvFile" class="block text-sm font-medium text-gray-700">Choose CSV File</label>
                                        <input type="file" id="csvFile" accept=".csv" 
                                               class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                        <p class="mt-1 text-xs text-gray-500">CSV format: One unique ID per line</p>
                                        <p class="mt-1 text-xs text-gray-400">Example: SD001 (each ID on a new line)</p>
                                    </div>
                                    <button type="button" id="uploadCsvBtn"
                                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                        Upload CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Participants List -->
                        <div class="bg-white border border-gray-200 rounded-lg">
                            <div class="px-6 py-4 border-b border-gray-200">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-lg font-semibold text-gray-800">Participants List</h3>
                                    <div class="flex space-x-2">
                                        <button id="refreshBtn" 
                                                class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                            Refresh
                                        </button>
                                        <button id="exportBtn" 
                                                class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                            Export CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="loadingState" class="hidden px-6 py-8 text-center">
                                <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                <p class="mt-2 text-gray-600">Loading participants...</p>
                            </div>

                            <!-- Participants Table -->
                            <div id="participantsTable" class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unique ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="participantsTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Participants will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Empty State -->
                            <div id="emptyState" class="hidden px-6 py-8 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">No participants</h3>
                                <p class="mt-1 text-sm text-gray-500">Get started by adding a participant or uploading a CSV file.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('adminDashboardContent').innerHTML = dashboardHTML;
            
            // Re-initialize event listeners after loading content
            setupAdminDashboardEventListeners();
        }

        function logout() {
            currentLoggedInAdmin = null;
            showAuthScreen();
            document.getElementById('adminLoginForm').reset();
        }

        // Check authentication on page load
        function checkAuthentication() {
            // For simplicity, we'll require login each time
            // In production, you might use session storage or tokens
            showAuthScreen();
        }

        // Initialize dashboard
        async function initDashboard() {
            checkAuthentication();
        }

        function setupAdminDashboardEventListeners() {
            // Add single participant form
            document.getElementById('addParticipantForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const participantId = document.getElementById('participantId').value.trim();
                
                if (!participantId) {
                    showNotification('Please enter a unique ID', 'error');
                    return;
                }
                
                console.log('Attempting to add participant:', participantId);
                console.log('Using DATABASE_ID:', DATABASE_ID);
                console.log('Using PARTICIPANTS_COLLECTION_ID:', PARTICIPANTS_COLLECTION_ID);
                
                try {
                    // Check if participant already exists
                    const existingParticipants = await databases.listDocuments(
                        DATABASE_ID,
                        PARTICIPANTS_COLLECTION_ID,
                        [Query.equal('uniqueId', participantId)]
                    );
                    
                    if (existingParticipants.documents.length > 0) {
                        showNotification('Participant ID already exists', 'error');
                        return;
                    }
                    
                    const participantData = {
                        uniqueId: participantId
                    };
                    
                    console.log('Creating document with data:', participantData);
                    
                    const result = await databases.createDocument(
                        DATABASE_ID,
                        PARTICIPANTS_COLLECTION_ID,
                        ID.unique(),
                        participantData
                    );
                    
                    console.log('Document created successfully:', result);
                    
                    // Reset form and refresh data
                    this.reset();
                    await loadDashboardData();
                    await renderParticipants();
                    
                    showNotification('Participant added successfully!', 'success');
                } catch (error) {
                    console.error('Error adding participant:', error);
                    showNotification('Failed to add participant: ' + error.message, 'error');
                }
            });
            };

            // CSV upload functionality
            document.getElementById('uploadCsvBtn').addEventListener('click', async function() {
                const fileInput = document.getElementById('csvFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    showNotification('Please select a CSV file', 'error');
                    return;
                }
                
                console.log('CSV file selected:', file.name, 'Size:', file.size);
                console.log('Using DATABASE_ID:', DATABASE_ID);
                console.log('Using PARTICIPANTS_COLLECTION_ID:', PARTICIPANTS_COLLECTION_ID);
                
                // Disable button during upload
                const uploadBtn = document.getElementById('uploadCsvBtn');
                const originalText = uploadBtn.textContent;
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'Processing...';
                
                try {
                    const text = await file.text();
                    console.log('Raw CSV content length:', text.length);
                    console.log('First 100 characters:', text.substring(0, 100));
                    
                    // Better line splitting that handles different line endings
                    const lines = text.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
                    console.log('Lines found:', lines.length);
                    console.log('Sample lines:', lines.slice(0, 5));
                    
                    if (lines.length === 0) {
                        showNotification('CSV file is empty or contains no valid data', 'error');
                        return;
                    }
                    
                    const participants = [];
                    const errors = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i];
                        
                        // Handle CSV with commas - take first column
                        if (line.includes(',')) {
                            line = line.split(',')[0];
                        }
                        
                        // Remove quotes and clean up
                        const uniqueId = line.replace(/['"]/g, '').trim();
                        
                        // Skip empty lines or common headers
                        if (!uniqueId || uniqueId.toLowerCase().match(/^(unique_?id|id|participant_?id)$/)) {
                            continue;
                        }
                        
                        // Validate ID format
                        if (uniqueId.length > 255) {
                            errors.push(`Line ${i + 1}: "${uniqueId}" is too long (max 255 characters)`);
                            continue;
                        }
                        
                        if (!/^[a-zA-Z0-9_-]+$/.test(uniqueId)) {
                            errors.push(`Line ${i + 1}: "${uniqueId}" contains invalid characters (only letters, numbers, hyphens, and underscores allowed)`);
                            continue;
                        }
                        
                        // Check for duplicates within the file
                        if (participants.some(p => p.uniqueId === uniqueId)) {
                            errors.push(`Line ${i + 1}: "${uniqueId}" is duplicated in the file`);
                            continue;
                        }
                        
                        participants.push({ uniqueId });
                    }
                    
                    console.log('Processed participants:', participants);
                    console.log('Validation errors:', errors);
                    
                    if (participants.length === 0) {
                        let errorMsg = 'No valid participants found in CSV';
                        if (errors.length > 0) {
                            errorMsg += '. Errors found: ' + errors.slice(0, 3).join('; ');
                            if (errors.length > 3) errorMsg += ` ... and ${errors.length - 3} more`;
                        }
                        showNotification(errorMsg, 'error');
                        return;
                    }
                    
                    // Upload participants
                    let successCount = 0;
                    let errorCount = 0;
                    let skippedCount = 0;
                    const uploadErrors = [];
                    
                    for (const participant of participants) {
                        try {
                            // Check if participant already exists
                            const existingParticipants = await databases.listDocuments(
                                DATABASE_ID,
                                PARTICIPANTS_COLLECTION_ID,
                                [Query.equal('uniqueId', participant.uniqueId)]
                            );
                            
                            if (existingParticipants.documents.length > 0) {
                                console.log('Participant already exists:', participant.uniqueId);
                                skippedCount++;
                                continue; // Skip existing participants
                            }
                            
                            const participantData = {
                                uniqueId: participant.uniqueId
                            };
                            
                            console.log('Creating participant:', participantData);
                            
                            const result = await databases.createDocument(
                                DATABASE_ID,
                                PARTICIPANTS_COLLECTION_ID,
                                ID.unique(),
                                participantData
                            );
                            
                            console.log('Created participant successfully:', result);
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            console.error('Error adding participant:', participant.uniqueId, error);
                            uploadErrors.push(`${participant.uniqueId}: ${error.message}`);
                        }
                    }
                    
                    // Clear file input
                    fileInput.value = '';
                    
                    // Refresh data
                    await loadDashboardData();
                    await renderParticipants();
                    
                    // Show comprehensive results
                    let message = `CSV upload completed: ${successCount} added`;
                    if (skippedCount > 0) message += `, ${skippedCount} already existed`;
                    if (errorCount > 0) message += `, ${errorCount} failed`;
                    if (errors.length > 0) message += `, ${errors.length} validation errors`;
                    
                    const messageType = successCount > 0 ? 'success' : (errorCount > 0 ? 'error' : 'warning');
                    showNotification(message, messageType);
                    
                    // Log detailed errors if any
                    if (uploadErrors.length > 0) {
                        console.error('Upload errors:', uploadErrors);
                    }
                    if (errors.length > 0) {
                        console.warn('Validation errors:', errors);
                    }
                    
                } catch (error) {
                    console.error('Error processing CSV:', error);
                    showNotification('Failed to process CSV file: ' + error.message, 'error');
                } finally {
                    // Re-enable button
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = originalText;
                }
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', async function() {
                await loadDashboardData();
                await renderParticipants();
                showNotification('Data refreshed successfully!', 'success');
            });

            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
                exportParticipants();
            });

        // Load dashboard data after authentication
        async function loadDashboardData() {
            await loadStatistics();
            await renderParticipants();
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const participantsResponse = await databases.listDocuments(DATABASE_ID, PARTICIPANTS_COLLECTION_ID);
                allParticipants = participantsResponse.documents;

                const totalParticipants = allParticipants.length;

                document.getElementById('totalParticipants').textContent = totalParticipants;
                document.getElementById('csvUploads').textContent = totalParticipants > 0 ? '1' : '0';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Render participants table
        async function renderParticipants() {
            const tbody = document.getElementById('participantsTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (allParticipants.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = allParticipants.map(participant => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${participant.uniqueId}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(participant.$createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteParticipant('${participant.$id}')" 
                                class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete participant function
        async function deleteParticipant(documentId) {
            if (confirm('Are you sure you want to delete this participant?')) {
                try {
                    await databases.deleteDocument(DATABASE_ID, PARTICIPANTS_COLLECTION_ID, documentId);
                    await loadDashboardData();
                    showNotification('Participant deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting participant:', error);
                    showNotification('Failed to delete participant: ' + error.message, 'error');
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                'bg-blue-100 text-blue-800 border border-blue-200'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-current opacity-70 hover:opacity-100">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Bulk upload functionality
        async function uploadParticipantIds(uniqueIds) {
            const results = { success: 0, failed: 0, errors: [] };
            
            for (const uniqueId of uniqueIds) {
                const trimmedId = uniqueId.trim();
                
                // Skip empty IDs
                if (!trimmedId) continue;
                
                try {
                    // Validate ID format before attempting to upload
                    if (trimmedId.length > 255) {
                        results.errors.push(`${trimmedId}: ID too long (max 255 characters)`);
                        results.failed++;
                        continue;
                    }
                    
                    if (!/^[a-zA-Z0-9_-]+$/.test(trimmedId)) {
                        results.errors.push(`${trimmedId}: Invalid characters (only letters, numbers, hyphens, and underscores allowed)`);
                        results.failed++;
                        continue;
                    }
                    
                    // Check if ID already exists
                    const existing = await databases.listDocuments(
                        DATABASE_ID,
                        PARTICIPANTS_COLLECTION_ID,
                        [Query.equal('uniqueId', trimmedId)]
                    );

                    if (existing.documents.length === 0) {
                        // Create new participant ID
                        await databases.createDocument(
                            DATABASE_ID,
                            PARTICIPANTS_COLLECTION_ID,
                            ID.unique(),
                            { uniqueId: trimmedId }
                        );
                        results.success++;
                        console.log(`Successfully uploaded: ${trimmedId}`);
                    } else {
                        results.errors.push(`${trimmedId}: Already exists`);
                        results.failed++;
                    }
                } catch (error) {
                    console.error(`Error uploading ${trimmedId}:`, error);
                    let errorMessage = error.message;
                    
                    // Provide more specific error messages
                    if (errorMessage.includes('Invalid document structure')) {
                        errorMessage = 'Invalid ID format or structure';
                    } else if (errorMessage.includes('uniqueId')) {
                        errorMessage = 'ID validation failed';
                    }
                    
                    results.errors.push(`${trimmedId}: ${errorMessage}`);
                    results.failed++;
                }
            }
            
            return results;
        }

        // Load existing participant IDs
        async function loadExistingParticipantIds() {
            try {
                const participantsResponse = await databases.listDocuments(
                    DATABASE_ID,
                    PARTICIPANTS_COLLECTION_ID
                );

                const submissionsResponse = await databases.listDocuments(
                    DATABASE_ID,
                    COLLECTION_ID
                );

                allParticipants = participantsResponse.documents;
                allSubmissions = submissionsResponse.documents;

                displayParticipants(allParticipants);
                updateTotalCount();
            } catch (error) {
                console.error('Error loading participant IDs:', error);
                document.getElementById('existingIdsList').innerHTML = 
                    '<p class="p-4 text-red-500">Error loading participant IDs.</p>';
            }
        }

        // Display participants with submission status
        function displayParticipants(participants) {
            const listContainer = document.getElementById('existingIdsList');
            
            if (participants.length === 0) {
                listContainer.innerHTML = '<p class="p-4 text-gray-500">No participant IDs found.</p>';
                return;
            }

            listContainer.innerHTML = participants
                .map(participant => {
                    const hasSubmitted = allSubmissions.some(sub => sub.uniqueId === participant.uniqueId);
                    const statusBadge = hasSubmitted 
                        ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Submitted</span>'
                        : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>';
                    
                    return `
                        <div class="flex justify-between items-center py-3 px-4 hover:bg-gray-50">
                            <div class="flex items-center space-x-3">
                                <span class="font-mono text-sm font-medium">${participant.uniqueId}</span>
                                ${statusBadge}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">${new Date(participant.$createdAt).toLocaleDateString()}</span>
                                <button 
                                    onclick="deleteParticipantId('${participant.$id}', '${participant.uniqueId}')" 
                                    class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 rounded hover:bg-red-50"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Filter and search participants
        function filterParticipants() {
            const searchTerm = document.getElementById('searchParticipants').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;

            let filtered = allParticipants.filter(participant => {
                const matchesSearch = participant.uniqueId.toLowerCase().includes(searchTerm);
                
                if (statusFilter === 'all') return matchesSearch;
                
                const hasSubmitted = allSubmissions.some(sub => sub.uniqueId === participant.uniqueId);
                const matchesStatus = statusFilter === 'submitted' ? hasSubmitted : !hasSubmitted;
                
                return matchesSearch && matchesStatus;
            });

            displayParticipants(filtered);
            document.getElementById('filteredIdsCount').textContent = filtered.length;
        }

        // Update total count
        function updateTotalCount() {
            document.getElementById('totalIdsCount').textContent = allParticipants.length;
            document.getElementById('filteredIdsCount').textContent = allParticipants.length;
        }

        // Delete participant ID
        async function deleteParticipantId(documentId, uniqueId) {
            if (confirm(`Are you sure you want to delete "${uniqueId}"?`)) {
                try {
                    await databases.deleteDocument(DATABASE_ID, PARTICIPANTS_COLLECTION_ID, documentId);
                    await loadExistingParticipantIds();
                    await loadStatistics();
                } catch (error) {
                    console.error('Error deleting participant ID:', error);
                    alert('Error deleting participant ID. Please try again.');
                }
            }
        }

        // Export participants to CSV
        function exportParticipants() {
            const csvContent = [
                'unique_id,status,created_date',
                ...allParticipants.map(participant => {
                    const hasSubmitted = allSubmissions.some(sub => sub.uniqueId === participant.uniqueId);
                    const status = hasSubmitted ? 'submitted' : 'pending';
                    const date = new Date(participant.$createdAt).toISOString().split('T')[0];
                    return `${participant.uniqueId},${status},${date}`;
                })
            ].join('\\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `participants-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Download CSV template
        function downloadTemplate() {
            const template = `unique_id
participant001
participant002
participant003
student-john-doe
team-alpha-2024`;

            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'participants-template.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Make functions global for onclick handlers
        window.deleteParticipant = deleteParticipant;

        // Authentication event handlers
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Login form submitted');
            
            const username = document.getElementById('adminUsername').value.trim();
            const loginBtn = document.getElementById('adminLoginBtn');
            const loginBtnText = document.getElementById('adminLoginBtnText');
            const loginSpinner = document.getElementById('adminLoginSpinner');
            const authError = document.getElementById('adminAuthError');
            
            console.log('Username entered:', username);
            
            if (!username) {
                authError.textContent = 'Please enter your username.';
                authError.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Signing in...';
            loginSpinner.classList.remove('hidden');
            authError.classList.add('hidden');
            
            try {
                console.log('Starting authentication...');
                await authenticateAdmin(username);
                console.log('Authentication successful, showing dashboard...');
                showDashboard();
                // Initialize dashboard data after successful login
                await loadDashboardData();
            } catch (error) {
                console.error('Login error:', error);
                authError.textContent = error.message || 'Login failed. Please try again.';
                authError.classList.remove('hidden');
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Sign in as Administrator';
                loginSpinner.classList.add('hidden');
            }
        });

        // Admin logout button handler  
        document.getElementById('adminLogoutBtn').addEventListener('click', logout);

        // Initialize dashboard on load
        initDashboard();
    </script>

    <!-- Developer Tools Blocking Script -->
    <script>
        // Disable right-click context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        document.addEventListener('keydown', function(e) {
            // F12
            if (e.keyCode === 123) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+Shift+I (Developer Tools)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+Shift+C (Inspect Element)
            if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+S (Save Page)
            if (e.ctrlKey && e.keyCode === 83) {
                e.preventDefault();
                return false;
            }
            
            // Ctrl+A (Select All)
            if (e.ctrlKey && e.keyCode === 65) {
                e.preventDefault();
                return false;
            }
        });

        // Detect if developer tools are open
        let devtools = {
            open: false,
            orientation: null
        };

        const threshold = 160;

        setInterval(function() {
            if (window.outerHeight - window.innerHeight > threshold || 
                window.outerWidth - window.innerWidth > threshold) {
                if (!devtools.open) {
                    devtools.open = true;
                    document.body.innerHTML = '<div style="background: #000; color: #fff; text-align: center; padding: 50px; font-family: Arial;"><h1>Access Denied</h1><p>Developer tools are not allowed on this page.</p></div>';
                }
            } else {
                devtools.open = false;
            }
        }, 500);

        // Disable text selection
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable drag
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });

       

        // Override console methods
        window.console.log = function() {};
        window.console.warn = function() {};
        window.console.error = function() {};
        window.console.info = function() {};
        window.console.debug = function() {};
    </script>
    </div> <!-- End adminDashboardContent -->
</body>
</html>
